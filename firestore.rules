/**
 * Firestore Security Rules — deploy these in Firebase Console
 *
 * How to deploy:
 *   1. Install Firebase CLI:  npm install -g firebase-tools
 *   2. Login:                 firebase login
 *   3. Init project:          firebase init firestore
 *   4. Replace default rules with these
 *   5. Deploy:                firebase deploy --only firestore:rules
 *
 * OR copy-paste directly into Firebase Console → Firestore → Rules tab
 */

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: check if the signed-in user's email is in the allowlist
    function isAllowedEmail(companyId) {
      let accessDoc = get(/databases/$(database)/documents/companies/$(companyId)/settings/access);
      return request.auth != null &&
             request.auth.token.email in accessDoc.data.allowed_emails;
    }

    // All company data — only allowlisted emails can read/write
    match /companies/{companyId}/{document=**} {
      allow read, write: if isAllowedEmail(companyId);
    }
  }
}
